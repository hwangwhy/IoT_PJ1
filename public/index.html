<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bảng Điều Khiển</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="../public/header.css">
    <style>
        body {
            background-color: #1e1e1e;
            color: white;
            display: flex;
        }

        .content {
            margin-left: 270px;
            width: 100%;
            padding: 20px;
        }

        .card {
            background-color: #2a2a2a;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked+.slider {
            background-color: #007bff;
        }

        input:checked+.slider:before {
            transform: translateX(26px);
        }

        input:disabled+.slider {
            background-color: #666;
            cursor: not-allowed;
        }

        #summaryChart {
            width: 100% !important;
            height: 400px !important;
            max-height: 400px;
        }

        .blink-red {
            animation: blink 1s infinite;
        }

        @keyframes blink {
            50% {
                background-color: red;
            }
        }

        /* Loading overlay styles */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }

        .loading-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>

<body>
    <div id="header-container"></div>
    <!-- Add loading overlay -->
    <div class="loading-overlay">
        <div class="loading-spinner"></div>
    </div>
    <div class="container mt-4">
        <!-- Phần 1: Hiển thị thông số cảm biến -->
        <div class="row text-center">
            <div class="col-md-3">
                <div class="card p-3">
                    <h5>Nhiệt độ</h5>
                    <h2 id="tempValue"></h2>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card p-3">
                    <h5>Độ ẩm</h5>
                    <h2 id="humidityValue"></h2>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card p-3">
                    <h5>Cường độ ánh sáng</h5>
                    <h2 id="lightValue"></h2>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card p-3" id="windSpeedCard">
                    <h5>Tốc độ gió</h5>
                    <h2 id="windSpeedValue"></h2>
                </div>
            </div>
        </div>

        <!-- Biểu đồ tổng hợp -->
        <div class="row mt-4">
            <div class="col-md-12">
                <div class="card p-3">
                    <h5>Biểu đồ nhiệt độ, độ ẩm, cường độ ánh sáng & tốc độ gió</h5>
                    <canvas id="summaryChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Phần 2: Nút bật/tắt thiết bị -->
        <div class="row mt-4" id="deviceControls">
        </div>
    </div>

    <script>
        // Load header.html vào div #header-container
        fetch("../public/header.html")
            .then(response => response.text())
            .then(data => {
                document.getElementById("header-container").innerHTML = data;

                let scripts = document.getElementById("header-container").getElementsByTagName("script");
                for (let script of scripts) {
                    eval(script.innerText);
                }
            });

        async function loadDevices() {
            try {
                let response = await fetch("../api/get_devices.php");
                let data = await response.json();

                let deviceContainer = document.getElementById("deviceControls");
                deviceContainer.innerHTML = "";

                data.forEach(device => {
                    let checked = device.status == 1 ? "checked" : "";
                    let col = document.createElement("div");
                    col.className = "col-md-3";
                    col.innerHTML = `
                        <div class="card p-3 text-center">
                            <h5>${device.name}</h5>
                            <label class="switch">
                                <input type="checkbox" class="toggle" data-id="${device.id}" ${checked}>
                                <span class="slider"></span>
                            </label>
                        </div>
                    `;
                    deviceContainer.appendChild(col);
                });

                document.querySelectorAll(".toggle").forEach(button => {
                    button.addEventListener("change", async function () {
                        let deviceId = this.getAttribute("data-id");
                        let status = this.checked ? 1 : 0;
                        this.disabled = true; // Disable toggle during request

                        // Show loading overlay
                        const loadingOverlay = document.querySelector('.loading-overlay');
                        loadingOverlay.classList.add('active');

                        try {
                            // First, update the database but don't send MQTT message yet
                            let response = await fetch("../api/toggle_device.php", {
                                method: "POST",
                                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                                body: `device_id=${deviceId}&status=${status}&delay=1`
                            });

                            if (!response.ok) {
                                throw new Error(`HTTP error! status: ${response.status}`);
                            }

                            let result = await response.json();
                            if (!result.success) {
                                alert("Lỗi khi cập nhật thiết bị: " + (result.error || "Không xác định"));
                                this.checked = !status; // Revert toggle on error
                            }
                            
                        } catch (error) {
                            console.error("Lỗi khi gửi yêu cầu: ", error);
                            alert("Lỗi kết nối đến máy chủ: " + error.message);
                            this.checked = !status; // Revert toggle on error
                        } finally {
                            // Hide loading overlay after 1 second
                            setTimeout(() => {
                                loadingOverlay.classList.remove('active');
                                this.disabled = false; // Re-enable toggle
                            }, 1000);
                        }
                    });
                });
            } catch (error) {
                console.error("Lỗi khi tải danh sách thiết bị: ", error);
            }
        }

        async function fetchSensorData() {
            try {
                let response = await fetch("../api/get_sensor.php");
                let responseData = await response.json();

                if (!responseData.latest || responseData.data.length === 0) {
                    console.warn("Không có dữ liệu cảm biến!");
                    return;
                }

                let latest = responseData.latest;
                document.getElementById("tempValue").textContent = latest.temperature + "°C";
                document.getElementById("humidityValue").textContent = latest.humidity + "%";
                document.getElementById("lightValue").textContent = latest.light + " lx";
                document.getElementById("windSpeedValue").textContent = latest.wind_speed + " m/s";

                const windSpeedCard = document.getElementById("windSpeedCard");
                if (latest.wind_speed > 60) {
                    windSpeedCard.classList.add("blink-red");
                } else {
                    windSpeedCard.classList.remove("blink-red");
                }
            } catch (error) {
                console.error("Lỗi khi tải dữ liệu cảm biến: ", error);
            }
        }

        async function fetchData() {
            try {
                const response = await fetch('../api/chart_data.php');
                const data = await response.json();

                if (!Array.isArray(data) || data.length === 0) {
                    console.warn("Dữ liệu biểu đồ rỗng hoặc không hợp lệ");
                    return;
                }

                const labels = data.map(row => row.timestamp);
                const tempData = data.map(row => row.temperature);
                const humidityData = data.map(row => row.humidity);
                const lightData = data.map(row => row.light);
                const windSpeedData = data.map(row => row.wind_speed);

                updateChart(labels, tempData, humidityData, lightData, windSpeedData);
            } catch (error) {
                console.error('Lỗi tải dữ liệu:', error);
            }
        }

        let chartInstance = null;

        function updateChart(labels, tempData, humidityData, lightData, windSpeedData) {
            const ctx = document.getElementById('summaryChart').getContext('2d');

            if (chartInstance !== null) {
                chartInstance.destroy();
                chartInstance = null;
            }

            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Nhiệt độ (°C)',
                            data: tempData,
                            borderColor: 'red',
                            backgroundColor: 'rgba(255, 0, 0, 0.2)',
                            fill: true
                        },
                        {
                            label: 'Độ ẩm (%)',
                            data: humidityData,
                            borderColor: 'blue',
                            backgroundColor: 'rgba(0, 0, 255, 0.2)',
                            fill: true
                        },
                        {
                            label: 'Ánh sáng (lx)',
                            data: lightData,
                            borderColor: 'yellow',
                            backgroundColor: 'rgba(255, 255, 0, 0.2)',
                            fill: true
                        },
                        {
                            label: 'Tốc độ gió (m/s)',
                            data: windSpeedData,
                            borderColor: 'green',
                            backgroundColor: 'rgba(0, 255, 0, 0.2)',
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { title: { display: true, text: 'Thời gian' } },
                        y: { title: { display: true, text: 'Giá trị' } }
                    }
                }
            });
        }

        // Gọi các hàm lần đầu khi trang tải
        fetchSensorData();
        fetchData();
        loadDevices();

        // Cập nhật dữ liệu định kỳ
        setInterval(fetchSensorData, 5000); // Cập nhật cảm biến mỗi 5 giây
        setInterval(fetchData, 5000);       // Cập nhật biểu đồ mỗi 5 giây
        setInterval(loadDevices, 10000);    // Cập nhật thiết bị mỗi 10 giây
    </script>
</body>

</html>