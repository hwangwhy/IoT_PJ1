<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>L·ªãch S·ª≠ Thao T√°c</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/datatables.net/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/datatables.net-bs5/js/dataTables.bootstrap5.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/datatables.net-bs5/css/dataTables.bootstrap5.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <link rel="stylesheet" href="../public/header.css">
    <style>
        body {
            background-color: #1e1e1e;
            color: white;
            display: flex;
        }

        .content {
            margin-left: 270px;
            width: 100%;
            padding: 20px;
        }

        .content {
            margin-left: 270px;
            width: 100%;
            padding: 20px;
        }

        .card {
            background-color: #2a2a2a;
            color: white;
        }

        .pagination {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }

        .pagination button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            background-color: #007bff;
            color: white;
            cursor: pointer;
        }

        .pagination button:hover {
            background-color: #0056b3;
        }
    </style>
</head>

<body>
    <div id="header-container"></div>

    <div class="container mt-4">
        <h2 class="text-center">L·ªãch s·ª≠ b·∫≠t/t·∫Øt thi·∫øt b·ªã</h2>

        <!-- √î t√¨m ki·∫øm v√† l·ªçc theo ng√†y -->
        <div class="row mb-3">
            <div class="col-md-4">
                <input type="text" id="searchKeyword" class="form-control" placeholder="Nh·∫≠p t·ª´ kh√≥a...">
            </div>
            <div class="col-md-3">
                <title>Ng√†y b·∫Øt ƒë·∫ßu</title>
                <input type="date" id="startDate" class="form-control">
            </div>
            <div class="col-md-3">
                <title>Ng√†y k·∫øt th√∫c</title>
                <input type="date" id="endDate" class="form-control">
            </div>
            <div class="col-md-2">
                <button class="btn btn-primary w-100" onclick="loadHistory(1)">T√¨m ki·∫øm</button>
            </div>
        </div>

        <table class="table table-dark">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>T√™n thi·∫øt b·ªã</th>
                    <th>H√†nh ƒë·ªông</th>
                    <th>Th·ªùi gian</th>
                </tr>
            </thead>
            <tbody id="historyTable"></tbody>
        </table>

        <!-- N√∫t ph√¢n trang -->
        <div id="pagination" class="text-center mt-3"></div>
    </div>


    <script>
        let currentPage = 1;

        $(document).ready(function () {
            // G·ªçi loadHistory khi trang t·∫£i
            loadHistory(1);

            // Khi nh·∫•n t√¨m ki·∫øm
            $("#searchButton").click(function () {
                loadHistory(1);
            });

            // Khi thay ƒë·ªïi ng√†y, t·ª± ƒë·ªông t√¨m ki·∫øm
            $("#startDate, #endDate").change(function () {
                loadHistory(1);
            });

            // Khi nh·∫≠p t·ª´ kh√≥a v√† nh·∫•n Enter, t·ª± ƒë·ªông t√¨m ki·∫øm
            $("#searchKeyword").keypress(function (event) {
                if (event.which === 13) { // 13 l√† m√£ ph√≠m Enter
                    loadHistory(1);
                }
            });
        });

        function loadHistory(page) {
            let keyword = $("#searchKeyword").val().trim();  // L·∫•y t·ª´ kh√≥a
            let startDate = $("#startDate").val();  // L·∫•y ng√†y b·∫Øt ƒë·∫ßu
            let endDate = $("#endDate").val();  // L·∫•y ng√†y k·∫øt th√∫c

            console.log(`üîç G·ª≠i request v·ªõi: page=${page}, keyword=${keyword}, startDate=${startDate}, endDate=${endDate}`);

            $.ajax({
                url: `../api/get_history.php`,
                type: "GET",
                data: { page: page, keyword: keyword, startDate: startDate, endDate: endDate },
                dataType: "json",
                success: function (data) {
                    let tableBody = $("#historyTable");
                    tableBody.empty();

                    if (data.history.length === 0) {
                        tableBody.append(`<tr><td colspan="4" class="text-center">Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu</td></tr>`);
                    } else {
                        data.history.forEach(row => {
                            tableBody.append(`<tr>
                        <td>${row.id}</td>
                        <td>${row.name}</td>
                        <td>${row.action}</td>
                        <td>${row.timestamp}</td>
                    </tr>`);
                        });
                    }

                    renderPagination(data.total_pages, page);
                },
                error: function (xhr, status, error) {
                    console.error("‚ùå L·ªói t·∫£i d·ªØ li·ªáu l·ªãch s·ª≠:", error);
                }
            });
        }

        // Khi trang t·∫£i xong, g·ªçi loadHistory()
        $(document).ready(function () {
            loadHistory(1);

            // Khi nh·∫•n t√¨m ki·∫øm
            $("#searchButton").click(function () {
                loadHistory(1);
            });

            // Khi thay ƒë·ªïi ng√†y, t·ª± ƒë·ªông t√¨m ki·∫øm
            $("#startDate, #endDate").change(function () {
                loadHistory(1);
            });

            // Khi nh·∫≠p t·ª´ kh√≥a v√† nh·∫•n Enter, t·ª± ƒë·ªông t√¨m ki·∫øm
            $("#searchKeyword").keypress(function (event) {
                if (event.which === 13) {
                    loadHistory(1);
                }
            });
        });


        function renderPagination(totalPages, currentPage) {
            let paginationDiv = $("#pagination");
            paginationDiv.empty();

            let paginationHtml = `<ul class="pagination justify-content-center">`;

            for (let i = 1; i <= totalPages; i++) {
                paginationHtml += `<li class="page-item ${i === currentPage ? 'active' : ''}">
            <a class="page-link" href="#" onclick="loadHistory(${i})">${i}</a>
        </li>`;
            }

            paginationHtml += `</ul>`;
            paginationDiv.html(paginationHtml);
        }


        $(document).ready(function () {
            loadHistory(currentPage);
        });
    </script>

    <script>
        // Load header.html v√†o div #header-container
        fetch("../public/header.html")
            .then(response => response.text())
            .then(data => {
                document.getElementById("header-container").innerHTML = data;
            });
    </script>
</body>

</html>